<?xml version="1.0" encoding="UTF-8"?>
<DataCompositionSchema xmlns="http://v8.1c.ru/8.1/data-composition-system/schema" xmlns:dcscom="http://v8.1c.ru/8.1/data-composition-system/common" xmlns:dcscor="http://v8.1c.ru/8.1/data-composition-system/core" xmlns:dcsset="http://v8.1c.ru/8.1/data-composition-system/settings" xmlns:v8="http://v8.1c.ru/8.1/data/core" xmlns:v8ui="http://v8.1c.ru/8.1/data/ui" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<dataSource>
		<name>DataSource1</name>
		<dataSourceType>Local</dataSourceType>
	</dataSource>
	<dataSet xsi:type="DataSetQuery">
		<name>DataSet</name>
		<field xsi:type="DataSetFieldField">
			<dataPath>ProductsAndServices</dataPath>
			<field>ProductsAndServices</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>en</v8:lang>
					<v8:content>Products and services</v8:content>
				</v8:item>
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Продукция и услуги</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Characteristic</dataPath>
			<field>Characteristic</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>en</v8:lang>
					<v8:content>Characteristic</v8:content>
				</v8:item>
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Characteristic</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Price</dataPath>
			<field>Price</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Barcode</dataPath>
			<field>Barcode</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>BalanceAtWarehouse</dataPath>
			<field>BalanceAtWarehouse</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>en</v8:lang>
					<v8:content>Balance at the Warehouse</v8:content>
				</v8:item>
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Остаток на складе</v8:content>
				</v8:item>
			</title>
			<useRestriction>
				<group>true</group>
				<order>true</order>
			</useRestriction>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Quantity</dataPath>
			<field>Quantity</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>en</v8:lang>
					<v8:content>Quantity</v8:content>
				</v8:item>
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Quantity</v8:content>
				</v8:item>
			</title>
			<useRestriction>
				<group>true</group>
				<order>true</order>
			</useRestriction>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Company</dataPath>
			<field>Company</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>en</v8:lang>
					<v8:content>Company</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>CurrentTime</dataPath>
			<field>CurrentTime</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>en</v8:lang>
					<v8:content>Current time</v8:content>
				</v8:item>
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Текущее время</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>CurrentUser</dataPath>
			<field>CurrentUser</field>
			<title xsi:type="v8:LocalStringType">
				<v8:item>
					<v8:lang>en</v8:lang>
					<v8:content>Current user</v8:content>
				</v8:item>
				<v8:item>
					<v8:lang>ru</v8:lang>
					<v8:content>Текущий пользователь</v8:content>
				</v8:item>
			</title>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>LastPriceChangeDate</dataPath>
			<field>LastPriceChangeDate</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Batch</dataPath>
			<field>Batch</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>StructuralUnit</dataPath>
			<field>StructuralUnit</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>PriceKind</dataPath>
			<field>PriceKind</field>
		</field>
		<dataSource>DataSource1</dataSource>
		<query>SELECT
	ProductsAndServices.Ref AS ProductsAndServices,
	ProductsAndServices.ProductsAndServicesType AS ProductsAndServicesType,
	VALUE(Catalog.ProductsAndServicesCharacteristics.EmptyRef) AS Characteristic,
	VALUE(Catalog.ProductsAndServicesBatches.EmptyRef) AS Batch
INTO NumChar
FROM
	Catalog.ProductsAndServices AS ProductsAndServices
WHERE
	ProductsAndServices.ProductsAndServicesType = VALUE(Enum.ProductsAndServicesTypes.InventoryItem)
	AND Not ProductsAndServices.DeletionMark
	AND Not ProductsAndServices.IsFolder

UNION ALL

SELECT
	ProductsAndServices.Ref,
	ProductsAndServices.ProductsAndServicesType,
	ProductsAndServicesCharacteristics.Ref,
	VALUE(Catalog.ProductsAndServicesBatches.EmptyRef)
FROM
	Catalog.ProductsAndServicesCharacteristics AS ProductsAndServicesCharacteristics
		INNER JOIN Catalog.ProductsAndServices AS ProductsAndServices
		ON (ProductsAndServices.Ref = ProductsAndServicesCharacteristics.Owner)
WHERE
	ProductsAndServicesCharacteristics.Owner.ProductsAndServicesType = VALUE(Enum.ProductsAndServicesTypes.InventoryItem)
	AND Not ProductsAndServicesCharacteristics.Owner.DeletionMark
	AND Not ProductsAndServicesCharacteristics.DeletionMark

UNION ALL

SELECT
	ProductsAndServices.Ref,
	ProductsAndServices.ProductsAndServicesType,
	ProductsAndServicesCharacteristics.Ref,
	VALUE(Catalog.ProductsAndServicesBatches.EmptyRef)
FROM
	Catalog.ProductsAndServicesCharacteristics AS ProductsAndServicesCharacteristics
		INNER JOIN Catalog.ProductsAndServices AS ProductsAndServices
		ON (ProductsAndServices.ProductsAndServicesCategory = ProductsAndServicesCharacteristics.Owner)
WHERE
	ProductsAndServicesCharacteristics.Owner.ProductsAndServicesType = VALUE(Enum.ProductsAndServicesTypes.InventoryItem)
	AND Not ProductsAndServicesCharacteristics.Owner.DeletionMark
	AND Not ProductsAndServicesCharacteristics.DeletionMark
;

////////////////////////////////////////////////////////////////////////////////
SELECT
	NumChar.ProductsAndServices AS ProductsAndServices,
	NumChar.Characteristic AS Characteristic,
	NumChar.Batch AS Batch
INTO SourceData
FROM
	NumChar AS NumChar

UNION ALL

SELECT
	NumChar.ProductsAndServices,
	NumChar.Characteristic,
	ProductsAndServicesBatches.Ref
FROM
	Catalog.ProductsAndServicesBatches AS ProductsAndServicesBatches
		INNER JOIN NumChar AS NumChar
		ON ProductsAndServicesBatches.Owner = NumChar.ProductsAndServices
WHERE
	ProductsAndServicesBatches.Owner.ProductsAndServicesType = VALUE(Enum.ProductsAndServicesTypes.InventoryItem)
	AND Not ProductsAndServicesBatches.Owner.DeletionMark
	AND Not ProductsAndServicesBatches.DeletionMark

UNION ALL

SELECT
	NumChar.ProductsAndServices,
	NumChar.Characteristic,
	ProductsAndServicesBatches.Ref
FROM
	Catalog.ProductsAndServicesBatches AS ProductsAndServicesBatches
		INNER JOIN NumChar AS NumChar
		ON ProductsAndServicesBatches.Owner = NumChar.ProductsAndServicesType
WHERE
	ProductsAndServicesBatches.Owner.ProductsAndServicesType = VALUE(Enum.ProductsAndServicesTypes.InventoryItem)
	AND Not ProductsAndServicesBatches.Owner.DeletionMark
	AND Not ProductsAndServicesBatches.DeletionMark

INDEX BY
	ProductsAndServices,
	Characteristic,
	Batch
;

////////////////////////////////////////////////////////////////////////////////
SELECT
	Barcodes.ProductsAndServices AS ProductsAndServices,
	Barcodes.Characteristic AS Characteristic,
	Barcodes.Batch AS Batch,
	Barcodes.Barcode AS Barcode
INTO ProductsAndServicesBarcodes
FROM
	InformationRegister.ProductsAndServicesBarcodes AS Barcodes
WHERE
	(Barcodes.ProductsAndServices, Barcodes.Characteristic, Barcodes.Batch) In
			(SELECT
				SourceData.ProductsAndServices,
				SourceData.Characteristic,
				SourceData.Batch
			FROM
				SourceData)
{WHERE
	Barcodes.ProductsAndServices.*,
	Barcodes.Characteristic.*,
	Barcodes.Batch.*}

GROUP BY
	Barcodes.ProductsAndServices,
	Barcodes.Characteristic,
	Barcodes.Batch,
	Barcodes.Barcode

INDEX BY
	ProductsAndServices,
	Characteristic,
	Batch
;

////////////////////////////////////////////////////////////////////////////////
SELECT
	SourceDataLastQuery.ProductsAndServices AS ProductsAndServices,
	SourceDataLastQuery.Characteristic AS Characteristic,
	SourceDataLastQuery.Batch AS Batch,
	ProductsAndServicesBarcodes.Barcode AS Barcode,
	MAX(PriceKinds.Ref) AS PriceKind,
	MAX(Companies.Ref) AS Company,
	MAX(ProductsAndServicesPricesSliceLast.Price) AS Price,
	MAX(ProductsAndServicesPricesSliceLast.Period) AS LastPriceChangeDate,
	MAX(1) AS Quantity,
	MAX(ProductsInInventoryBalances.QuantityBalance) AS BalanceAtWarehouse,
	MAX(&amp;CurrentTime) AS CurrentTime,
	MAX(Users.Ref) AS CurrentUser
{SELECT
	ProductsAndServices.*,
	Characteristic.*,
	Batch.*,
	Barcode,
	PriceKind.*,
	Company.*,
	Quantity,
	Price,
	LastPriceChangeDate,
	BalanceAtWarehouse,
	CurrentTime,
	CurrentUser.*}
FROM
	SourceData AS SourceDataLastQuery
		{LEFT JOIN ProductsAndServicesBarcodes AS ProductsAndServicesBarcodes
		ON SourceDataLastQuery.ProductsAndServices = ProductsAndServicesBarcodes.ProductsAndServices
			AND SourceDataLastQuery.Characteristic = ProductsAndServicesBarcodes.Characteristic
			AND SourceDataLastQuery.Batch = ProductsAndServicesBarcodes.Batch}
		{LEFT JOIN InformationRegister.ProductsAndServicesPrices.SliceLast(, PriceKind = &amp;PriceKind {(ProductsAndServices).* AS ProductsAndServices, (Characteristic).* AS Characteristic}) AS ProductsAndServicesPricesSliceLast
		ON SourceDataLastQuery.ProductsAndServices = ProductsAndServicesPricesSliceLast.ProductsAndServices
			AND (ProductsAndServicesPricesSliceLast.Characteristic = SourceDataLastQuery.Characteristic)}
		{LEFT JOIN Catalog.PriceKinds AS PriceKinds
		ON (PriceKinds.Ref = &amp;PriceKind)}
		{LEFT JOIN Catalog.Companies AS Companies
		ON (Companies.Ref = &amp;Company)}
		{LEFT JOIN Catalog.Users AS Users
		ON (Users.Ref = &amp;CurrentUser)}
		{LEFT JOIN AccumulationRegister.InventoryInWarehouses.Balance(
				,
				CASE
					WHEN &amp;Company = VALUE(Catalog.Companies.EmptyRef)
						THEN TRUE
					ELSE Company = &amp;Company
				END {(StructuralUnit).* AS StructuralUnit, (ProductsAndServices).* AS ProductsAndServices, (Characteristic).* AS Characteristic}) AS ProductsInInventoryBalances
		ON SourceDataLastQuery.ProductsAndServices = ProductsInInventoryBalances.ProductsAndServices
			AND SourceDataLastQuery.Characteristic = ProductsInInventoryBalances.Characteristic
			AND SourceDataLastQuery.Batch = ProductsInInventoryBalances.Batch}
{WHERE
	SourceDataLastQuery.ProductsAndServices.* AS ProductsAndServices,
	SourceDataLastQuery.Characteristic.* AS Characteristic,
	SourceDataLastQuery.Batch.* AS Batch,
	ProductsAndServicesBarcodes.Barcode AS Barcode,
	ProductsAndServicesPricesSliceLast.Price AS Price,
	ProductsAndServicesPricesSliceLast.Period AS LastPriceChangeDate,
	ProductsInInventoryBalances.QuantityBalance AS BalanceAtWarehouse}

GROUP BY
	SourceDataLastQuery.ProductsAndServices,
	SourceDataLastQuery.Characteristic,
	SourceDataLastQuery.Batch,
	ProductsAndServicesBarcodes.Barcode

ORDER BY
	SourceDataLastQuery.ProductsAndServices.Description</query>
		<autoFillFields>false</autoFillFields>
	</dataSet>
	<parameter>
		<name>Company</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>en</v8:lang>
				<v8:content>Company</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type xmlns:d4p1="http://v8.1c.ru/8.1/data/enterprise/current-config">d4p1:CatalogRef.Companies</v8:Type>
		</valueType>
		<value xsi:type="dcscor:DesignTimeValue">Catalog.Companies.EmptyRef</value>
		<useRestriction>true</useRestriction>
		<availableAsField>false</availableAsField>
	</parameter>
	<parameter>
		<name>CurrentTime</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>en</v8:lang>
				<v8:content>Current time</v8:content>
			</v8:item>
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Текущее время</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type>xs:dateTime</v8:Type>
			<v8:DateQualifiers>
				<v8:DateFractions>DateTime</v8:DateFractions>
			</v8:DateQualifiers>
		</valueType>
		<value xsi:nil="true"/>
		<useRestriction>true</useRestriction>
		<availableAsField>false</availableAsField>
	</parameter>
	<parameter>
		<name>CurrentUser</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>en</v8:lang>
				<v8:content>Current user</v8:content>
			</v8:item>
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Текущий пользователь</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type xmlns:d4p1="http://v8.1c.ru/8.1/data/enterprise/current-config">d4p1:CatalogRef.Users</v8:Type>
		</valueType>
		<value xsi:type="dcscor:DesignTimeValue">Catalog.Users.EmptyRef</value>
		<useRestriction>true</useRestriction>
		<availableAsField>false</availableAsField>
	</parameter>
	<parameter>
		<name>PriceKind</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>en</v8:lang>
				<v8:content>Price kind</v8:content>
			</v8:item>
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Вид цены</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type xmlns:d4p1="http://v8.1c.ru/8.1/data/enterprise/current-config">d4p1:CatalogRef.PriceKinds</v8:Type>
		</valueType>
		<value xsi:type="dcscor:DesignTimeValue">Catalog.PriceKinds.EmptyRef</value>
		<useRestriction>true</useRestriction>
	</parameter>
	<settingsVariant>
		<dcsset:name>Default</dcsset:name>
		<dcsset:presentation xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>en</v8:lang>
				<v8:content>Default</v8:content>
			</v8:item>
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Default</v8:content>
			</v8:item>
		</dcsset:presentation>
		<dcsset:settings xmlns:style="http://v8.1c.ru/8.1/data/ui/style" xmlns:sys="http://v8.1c.ru/8.1/data/ui/fonts/system" xmlns:web="http://v8.1c.ru/8.1/data/ui/colors/web" xmlns:win="http://v8.1c.ru/8.1/data/ui/colors/windows">
			<dcsset:filter>
				<dcsset:item xsi:type="dcsset:FilterItemComparison">
					<dcsset:use>false</dcsset:use>
					<dcsset:left xsi:type="dcscor:Field">StructuralUnit</dcsset:left>
					<dcsset:comparisonType>Equal</dcsset:comparisonType>
					<dcsset:right xsi:type="dcscor:DesignTimeValue">Catalog.StructuralUnits.EmptyRef</dcsset:right>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:FilterItemComparison">
					<dcsset:use>false</dcsset:use>
					<dcsset:left xsi:type="dcscor:Field">Barcode</dcsset:left>
					<dcsset:comparisonType>Equal</dcsset:comparisonType>
					<dcsset:right xsi:type="xs:string"/>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:FilterItemComparison">
					<dcsset:use>false</dcsset:use>
					<dcsset:left xsi:type="dcscor:Field">ProductsAndServices</dcsset:left>
					<dcsset:comparisonType>Equal</dcsset:comparisonType>
					<dcsset:right xsi:type="dcscor:DesignTimeValue">Catalog.ProductsAndServices.EmptyRef</dcsset:right>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:FilterItemComparison">
					<dcsset:use>false</dcsset:use>
					<dcsset:left xsi:type="dcscor:Field">ProductsAndServices.PriceGroup</dcsset:left>
					<dcsset:comparisonType>Equal</dcsset:comparisonType>
					<dcsset:right xsi:type="dcscor:DesignTimeValue">Catalog.PriceGroups.EmptyRef</dcsset:right>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:FilterItemComparison">
					<dcsset:use>false</dcsset:use>
					<dcsset:left xsi:type="dcscor:Field">Barcode</dcsset:left>
					<dcsset:comparisonType>Filled</dcsset:comparisonType>
					<dcsset:presentation xsi:type="xs:string">Only with barcode</dcsset:presentation>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:FilterItemComparison">
					<dcsset:use>false</dcsset:use>
					<dcsset:left xsi:type="dcscor:Field">Price</dcsset:left>
					<dcsset:comparisonType>Filled</dcsset:comparisonType>
					<dcsset:presentation xsi:type="xs:string">Only with prices</dcsset:presentation>
				</dcsset:item>
				<dcsset:item xsi:type="dcsset:FilterItemComparison">
					<dcsset:use>false</dcsset:use>
					<dcsset:left xsi:type="dcscor:Field">BalanceAtWarehouse</dcsset:left>
					<dcsset:comparisonType>Greater</dcsset:comparisonType>
					<dcsset:right xsi:type="xs:decimal">0</dcsset:right>
					<dcsset:presentation xsi:type="xs:string">Only with stock balance</dcsset:presentation>
				</dcsset:item>
			</dcsset:filter>
			<dcsset:dataParameters>
				<dcscor:item xsi:type="dcsset:SettingsParameterValue">
					<dcscor:use>false</dcscor:use>
					<dcscor:parameter>Company</dcscor:parameter>
					<dcscor:value xsi:type="dcscor:DesignTimeValue">Catalog.PriceKinds.EmptyRef</dcscor:value>
				</dcscor:item>
			</dcsset:dataParameters>
			<dcsset:item xsi:type="dcsset:StructureItemGroup">
				<dcsset:order>
					<dcsset:item xsi:type="dcsset:OrderItemAuto"/>
				</dcsset:order>
				<dcsset:selection>
					<dcsset:item xsi:type="dcsset:SelectedItemAuto"/>
				</dcsset:selection>
			</dcsset:item>
		</dcsset:settings>
	</settingsVariant>
</DataCompositionSchema>